# å®å¡”æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—

## ğŸš€ åœ¨å®å¡”é¢æ¿éƒ¨ç½²çº¯çœŸIPåº“æŸ¥è¯¢API

### ğŸ“‹ éƒ¨ç½²å‰å‡†å¤‡

#### 1. ç¯å¢ƒæ£€æŸ¥
ç¡®ä¿æ‚¨çš„å®å¡”æœåŠ¡å™¨å·²å®‰è£…ï¼š
- âœ… Node.js (>= 14.0.0)
- âœ… npm (>= 6.0.0)
- âœ… PM2 (è¿›ç¨‹ç®¡ç†å™¨)

#### 2. æ£€æŸ¥Node.jsç‰ˆæœ¬
```bash
# SSHç™»å½•æœåŠ¡å™¨åæ‰§è¡Œ
node --version
npm --version
```

### ğŸ“ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ é¡¹ç›®æ–‡ä»¶

#### æ–¹æ³•1ï¼šé€šè¿‡å®å¡”æ–‡ä»¶ç®¡ç†å™¨
1. ç™»å½•å®å¡”é¢æ¿
2. è¿›å…¥ **æ–‡ä»¶** ç®¡ç†
3. åˆ›å»ºé¡¹ç›®ç›®å½•ï¼š`/www/wwwroot/qqwry-api`
4. ä¸Šä¼ æ‰€æœ‰é¡¹ç›®æ–‡ä»¶åˆ°è¯¥ç›®å½•

#### æ–¹æ³•2ï¼šé€šè¿‡Gitå…‹éš†ï¼ˆæ¨èï¼‰
```bash
# SSHç™»å½•æœåŠ¡å™¨
cd /www/wwwroot
git clone https://github.com/zxlee920/qqwry-ip-api-server.git qqwry-api
cd qqwry-api
```

### ğŸ“¦ ç¬¬äºŒæ­¥ï¼šå®‰è£…ä¾èµ–

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /www/wwwroot/qqwry-api

# å®‰è£…é¡¹ç›®ä¾èµ–
npm install

# å…¨å±€å®‰è£…PM2ï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
npm install -g pm2
```

### ğŸ”§ ç¬¬ä¸‰æ­¥ï¼šé…ç½®ç¯å¢ƒ

#### 1. åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶
```bash
# å¤åˆ¶ç¯å¢ƒé…ç½®æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘é…ç½®æ–‡ä»¶
nano .env
```

#### 2. ä¿®æ”¹ç¯å¢ƒé…ç½®
```bash
# ç”Ÿäº§ç¯å¢ƒé…ç½®
NODE_ENV=production
PORT=3000
HOST=0.0.0.0

# ç¼“å­˜é…ç½®
CACHE_TTL=3600
CACHE_CHECK_PERIOD=600

# æ—¥å¿—é…ç½®
LOG_LEVEL=info
MAX_LOG_SIZE=10485760
MAX_LOG_FILES=10
```

### ğŸš€ ç¬¬å››æ­¥ï¼šå¯åŠ¨æœåŠ¡

#### æ–¹æ³•1ï¼šä½¿ç”¨PM2å¯åŠ¨ï¼ˆæ¨èï¼‰
```bash
# ä½¿ç”¨é¡¹ç›®é…ç½®å¯åŠ¨
npm run pm2-start

# æˆ–è€…ç›´æ¥ä½¿ç”¨PM2
pm2 start ecosystem.config.js

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status
pm2 logs qqwry-api
```

#### æ–¹æ³•2ï¼šç›´æ¥å¯åŠ¨ï¼ˆæµ‹è¯•ç”¨ï¼‰
```bash
# ç›´æ¥å¯åŠ¨ï¼ˆå‰å°è¿è¡Œï¼‰
npm start

# åå°è¿è¡Œ
nohup npm start > logs/app.log 2>&1 &
```

### ğŸŒ ç¬¬äº”æ­¥ï¼šé…ç½®Nginxåå‘ä»£ç†

#### 1. åœ¨å®å¡”é¢æ¿æ·»åŠ ç«™ç‚¹
1. è¿›å…¥ **ç½‘ç«™** ç®¡ç†
2. ç‚¹å‡» **æ·»åŠ ç«™ç‚¹**
3. åŸŸåï¼š`your-domain.com`ï¼ˆæˆ–IPåœ°å€ï¼‰
4. æ ¹ç›®å½•ï¼š`/www/wwwroot/qqwry-api`

#### 2. é…ç½®åå‘ä»£ç†
åœ¨å®å¡”é¢æ¿ä¸­ï¼š
1. ç‚¹å‡»ç«™ç‚¹ **è®¾ç½®**
2. é€‰æ‹© **åå‘ä»£ç†**
3. æ·»åŠ åå‘ä»£ç†ï¼š
   - **ä»£ç†åç§°**: qqwry-api
   - **ç›®æ ‡URL**: http://127.0.0.1:3000
   - **å‘é€åŸŸå**: $host
   - **å†…å®¹æ›¿æ¢**: ç•™ç©º

#### 3. é«˜çº§Nginxé…ç½®ï¼ˆå¯é€‰ï¼‰
```nginx
# åœ¨ç«™ç‚¹é…ç½®æ–‡ä»¶ä¸­æ·»åŠ 
location / {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    
    # è¶…æ—¶è®¾ç½®
    proxy_connect_timeout 10s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}

# APIé™æµ
location /ip/ {
    limit_req zone=api_limit burst=20 nodelay;
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
```

### ğŸ”’ ç¬¬å…­æ­¥ï¼šå®‰å…¨é…ç½®

#### 1. é˜²ç«å¢™è®¾ç½®
åœ¨å®å¡”é¢æ¿ **å®‰å…¨** ä¸­ï¼š
- å¼€æ”¾ç«¯å£ï¼š80, 443 (HTTP/HTTPS)
- å…³é—­ç«¯å£ï¼š3000 (Node.jsç›´æ¥è®¿é—®)

#### 2. SSLè¯ä¹¦é…ç½®ï¼ˆæ¨èï¼‰
1. åœ¨ç«™ç‚¹è®¾ç½®ä¸­é€‰æ‹© **SSL**
2. ç”³è¯·Let's Encryptå…è´¹è¯ä¹¦
3. å¼€å¯ **å¼ºåˆ¶HTTPS**

### ğŸ“Š ç¬¬ä¸ƒæ­¥ï¼šç›‘æ§å’Œç»´æŠ¤

#### 1. PM2ç›‘æ§
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs qqwry-api

# é‡å¯æœåŠ¡
pm2 restart qqwry-api

# åœæ­¢æœåŠ¡
pm2 stop qqwry-api

# æŸ¥çœ‹ç›‘æ§é¢æ¿
pm2 monit
```

#### 2. è®¾ç½®å¼€æœºè‡ªå¯
```bash
# ä¿å­˜PM2è¿›ç¨‹åˆ—è¡¨
pm2 save

# ç”Ÿæˆå¼€æœºå¯åŠ¨è„šæœ¬
pm2 startup

# æŒ‰ç…§æç¤ºæ‰§è¡Œç”Ÿæˆçš„å‘½ä»¤
```

#### 3. æ—¥å¿—ç®¡ç†
```bash
# å®‰è£…æ—¥å¿—è½®è½¬
pm2 install pm2-logrotate

# é…ç½®æ—¥å¿—è½®è½¬
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
pm2 set pm2-logrotate:compress true
```

### ğŸ§ª ç¬¬å…«æ­¥ï¼šæµ‹è¯•éƒ¨ç½²

#### 1. å¥åº·æ£€æŸ¥
```bash
# æµ‹è¯•APIæ˜¯å¦æ­£å¸¸
curl http://your-domain.com/health

# æµ‹è¯•IPæŸ¥è¯¢
curl http://your-domain.com/ip/8.8.8.8
```

#### 2. æ€§èƒ½æµ‹è¯•
```bash
# å®‰è£…å‹æµ‹å·¥å…·
npm install -g autocannon

# è¿›è¡Œå‹åŠ›æµ‹è¯•
autocannon -c 100 -d 30 http://your-domain.com/ip/8.8.8.8
```

### ğŸ”§ å¸¸è§é—®é¢˜è§£å†³

#### é—®é¢˜1ï¼šç«¯å£è¢«å ç”¨
```bash
# æŸ¥çœ‹ç«¯å£å ç”¨
netstat -tlnp | grep :3000

# æ€æ­»å ç”¨è¿›ç¨‹
kill -9 PID
```

#### é—®é¢˜2ï¼šæƒé™é—®é¢˜
```bash
# ä¿®æ”¹æ–‡ä»¶æƒé™
chown -R www:www /www/wwwroot/qqwry-api
chmod -R 755 /www/wwwroot/qqwry-api
```

#### é—®é¢˜3ï¼šå†…å­˜ä¸è¶³
```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨
free -h

# ä¼˜åŒ–PM2é…ç½®
# åœ¨ecosystem.config.jsä¸­è®¾ç½®max_memory_restart: '500M'
```

### ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 1. å¯ç”¨Gzipå‹ç¼©
åœ¨Nginxé…ç½®ä¸­æ·»åŠ ï¼š
```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types application/json text/plain application/javascript text/css;
```

#### 2. è®¾ç½®ç¼“å­˜å¤´
```nginx
location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

#### 3. å¯ç”¨HTTP/2
åœ¨å®å¡”SSLè®¾ç½®ä¸­å¯ç”¨HTTP/2æ”¯æŒ

### ğŸ¯ éƒ¨ç½²å®Œæˆæ£€æŸ¥æ¸…å•

- [ ] âœ… Node.jsç¯å¢ƒæ­£å¸¸
- [ ] âœ… é¡¹ç›®æ–‡ä»¶ä¸Šä¼ å®Œæˆ
- [ ] âœ… ä¾èµ–å®‰è£…æˆåŠŸ
- [ ] âœ… PM2æœåŠ¡å¯åŠ¨
- [ ] âœ… Nginxåå‘ä»£ç†é…ç½®
- [ ] âœ… é˜²ç«å¢™ç«¯å£è®¾ç½®
- [ ] âœ… SSLè¯ä¹¦é…ç½®
- [ ] âœ… å¼€æœºè‡ªå¯è®¾ç½®
- [ ] âœ… APIåŠŸèƒ½æµ‹è¯•é€šè¿‡

### ğŸš€ éƒ¨ç½²æˆåŠŸï¼

æ­å–œï¼æ‚¨çš„çº¯çœŸIPåº“æŸ¥è¯¢APIå·²æˆåŠŸéƒ¨ç½²åˆ°å®å¡”æœåŠ¡å™¨ï¼

**è®¿é—®åœ°å€**ï¼š
- APIé¦–é¡µï¼šhttps://your-domain.com/
- å¥åº·æ£€æŸ¥ï¼šhttps://your-domain.com/health
- IPæŸ¥è¯¢ï¼šhttps://your-domain.com/ip/8.8.8.8

**ç®¡ç†å‘½ä»¤**ï¼š
```bash
# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 status qqwry-api

# é‡å¯æœåŠ¡
pm2 restart qqwry-api

# æŸ¥çœ‹æ—¥å¿—
pm2 logs qqwry-api