# 宝塔服务器部署指南

## 🚀 在宝塔面板部署纯真IP库查询API

### 📋 部署前准备

#### 1. 环境检查
确保您的宝塔服务器已安装：
- ✅ Node.js (>= 14.0.0)
- ✅ npm (>= 6.0.0)
- ✅ PM2 (进程管理器)

#### 2. 检查Node.js版本
```bash
# SSH登录服务器后执行
node --version
npm --version
```

### 📁 第一步：上传项目文件

#### 方法1：通过宝塔文件管理器
1. 登录宝塔面板
2. 进入 **文件** 管理
3. 创建项目目录：`/www/wwwroot/qqwry-api`
4. 上传所有项目文件到该目录

#### 方法2：通过Git克隆（推荐）
```bash
# SSH登录服务器
cd /www/wwwroot
git clone https://github.com/zxlee920/qqwry-ip-api-server.git qqwry-api
cd qqwry-api
```

### 📦 第二步：安装依赖

```bash
# 进入项目目录
cd /www/wwwroot/qqwry-api

# 安装项目依赖
npm install

# 全局安装PM2（如果未安装）
npm install -g pm2
```

### 🔧 第三步：配置环境

#### 1. 创建环境配置文件
```bash
# 复制环境配置模板
cp .env.example .env

# 编辑配置文件
nano .env
```

#### 2. 修改环境配置
```bash
# 生产环境配置
NODE_ENV=production
PORT=3000
HOST=0.0.0.0

# 缓存配置
CACHE_TTL=3600
CACHE_CHECK_PERIOD=600

# 日志配置
LOG_LEVEL=info
MAX_LOG_SIZE=10485760
MAX_LOG_FILES=10
```

### 🚀 第四步：启动服务

#### 方法1：使用PM2启动（推荐）
```bash
# 使用项目配置启动
npm run pm2-start

# 或者直接使用PM2
pm2 start ecosystem.config.js

# 查看服务状态
pm2 status
pm2 logs qqwry-api
```

#### 方法2：直接启动（测试用）
```bash
# 直接启动（前台运行）
npm start

# 后台运行
nohup npm start > logs/app.log 2>&1 &
```

### 🌐 第五步：配置Nginx反向代理

#### 1. 在宝塔面板添加站点
1. 进入 **网站** 管理
2. 点击 **添加站点**
3. 域名：`your-domain.com`（或IP地址）
4. 根目录：`/www/wwwroot/qqwry-api`

#### 2. 配置反向代理
在宝塔面板中：
1. 点击站点 **设置**
2. 选择 **反向代理**
3. 添加反向代理：
   - **代理名称**: qqwry-api
   - **目标URL**: http://127.0.0.1:3000
   - **发送域名**: $host
   - **内容替换**: 留空

#### 3. 高级Nginx配置（可选）
```nginx
# 在站点配置文件中添加
location / {
    proxy_pass http://127.0.0.1:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    
    # 超时设置
    proxy_connect_timeout 10s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;
}

# API限流
location /ip/ {
    limit_req zone=api_limit burst=20 nodelay;
    proxy_pass http://127.0.0.1:3000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
```

### 🔒 第六步：安全配置

#### 1. 防火墙设置
在宝塔面板 **安全** 中：
- 开放端口：80, 443 (HTTP/HTTPS)
- 关闭端口：3000 (Node.js直接访问)

#### 2. SSL证书配置（推荐）
1. 在站点设置中选择 **SSL**
2. 申请Let's Encrypt免费证书
3. 开启 **强制HTTPS**

### 📊 第七步：监控和维护

#### 1. PM2监控
```bash
# 查看服务状态
pm2 status

# 查看日志
pm2 logs qqwry-api

# 重启服务
pm2 restart qqwry-api

# 停止服务
pm2 stop qqwry-api

# 查看监控面板
pm2 monit
```

#### 2. 设置开机自启
```bash
# 保存PM2进程列表
pm2 save

# 生成开机启动脚本
pm2 startup

# 按照提示执行生成的命令
```

#### 3. 日志管理
```bash
# 安装日志轮转
pm2 install pm2-logrotate

# 配置日志轮转
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
pm2 set pm2-logrotate:compress true
```

### 🧪 第八步：测试部署

#### 1. 健康检查
```bash
# 测试API是否正常
curl http://your-domain.com/health

# 测试IP查询
curl http://your-domain.com/ip/8.8.8.8
```

#### 2. 性能测试
```bash
# 安装压测工具
npm install -g autocannon

# 进行压力测试
autocannon -c 100 -d 30 http://your-domain.com/ip/8.8.8.8
```

### 🔧 常见问题解决

#### 问题1：端口被占用
```bash
# 查看端口占用
netstat -tlnp | grep :3000

# 杀死占用进程
kill -9 PID
```

#### 问题2：权限问题
```bash
# 修改文件权限
chown -R www:www /www/wwwroot/qqwry-api
chmod -R 755 /www/wwwroot/qqwry-api
```

#### 问题3：内存不足
```bash
# 查看内存使用
free -h

# 优化PM2配置
# 在ecosystem.config.js中设置max_memory_restart: '500M'
```

### 📈 性能优化建议

#### 1. 启用Gzip压缩
在Nginx配置中添加：
```nginx
gzip on;
gzip_vary on;
gzip_min_length 1024;
gzip_types application/json text/plain application/javascript text/css;
```

#### 2. 设置缓存头
```nginx
location ~* \.(js|css|png|jpg|jpeg|gif|ico)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
}
```

#### 3. 启用HTTP/2
在宝塔SSL设置中启用HTTP/2支持

### 🎯 部署完成检查清单

- [ ] ✅ Node.js环境正常
- [ ] ✅ 项目文件上传完成
- [ ] ✅ 依赖安装成功
- [ ] ✅ PM2服务启动
- [ ] ✅ Nginx反向代理配置
- [ ] ✅ 防火墙端口设置
- [ ] ✅ SSL证书配置
- [ ] ✅ 开机自启设置
- [ ] ✅ API功能测试通过

### 🚀 部署成功！

恭喜！您的纯真IP库查询API已成功部署到宝塔服务器！

**访问地址**：
- API首页：https://your-domain.com/
- 健康检查：https://your-domain.com/health
- IP查询：https://your-domain.com/ip/8.8.8.8

**管理命令**：
```bash
# 查看服务状态
pm2 status qqwry-api

# 重启服务
pm2 restart qqwry-api

# 查看日志
pm2 logs qqwry-api